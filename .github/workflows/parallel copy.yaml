name: HaulSafe E2E Cypress Parallel - Oficial

on:
  # schedule:
  #   - cron: '00 23 * * 1-5'
  workflow_dispatch:
jobs:
  cypress-run:
    runs-on: ubuntu-latest
    # container: cypress/browsers:node14.16.0-chrome90-ff88
    strategy:
      matrix:
        # containers: [accidents, company-documents, dashboard, dot, drivers, equipments, final-miles, integrations, jb-hunt, signup]
        containers: [accidents]
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with: 
          spec: ./cypress/e2e/${{ matrix.containers }}/*.js
          config-file: cypress.config.js
      
      - name: Debug Artifacts Before Upload
        run: |
          echo "List of generated files:"
          ls -R cypress/reports

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: cypress-results-${{ matrix.containers }}
          path: cypress/reports/

  merge-reports:
    runs-on: ubuntu-latest
    needs: cypress-run
    if: always()

    steps:
      - name: Download Mocha Reports 1
        uses: actions/download-artifact@v3
        if: always()
        with:
          name: cypress-results-accidents
          path: cypress/reports/

      - name: Debug Files
        if: always()
        run: |
          ls cypress/reports/
      - name: install
        if: always()
        run: |
          npm install mochawesome-merge mochawesome-report-generator mochawesome-report-generator mochawesome mocha
      # Faz o upload do relatÃ³rio final gerado
      - name: Upload Final Report
        uses: actions/upload-artifact@v3
        with:
          name: mochawesome-report
          path: mochareports


  #     - name: Upload test video
  #       uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: cypress-videos
  #         path: cypress/videos 
  
  # merge-reports:
  #   runs-on: ubuntu-latest
  #   needs: cypress-run
  #   if: always()

  #   steps:
  #     - name: Download Mocha Reports 1
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-equipments
  #         path: cypress/reports/1

  #     - name: Download Mocha Reports 3
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-drivers
  #         path: cypress/reports/3

  #     - name: Download Mocha Reports 4
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-jb-hunt
  #         path: cypress/reports/4
      
  #     - name: Download Mocha Reports 5
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-accidents
  #         path: cypress/reports/4
      
  #     - name: Download Mocha Reports 6
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-dot
  #         path: cypress/reports/6
      
  #     - name: Download Mocha Reports 7
  #       uses: actions/download-artifact@v4
  #       if: always()
  #       with:
  #         name: result-final-miles
  #         path: cypress/reports/7
      
  #     - name: Debug Files
  #       if: always()
  #       run: |
  #         ls cypress/reports/1
  #         ls cypress/reports/3
  #         ls cypress/reports/4
  #         ls cypress/reports/5
  #         ls cypress/reports/6
  #         ls cypress/reports/7

  #     - name: install
  #       if: always()
  #       run: |
  #         npm install mochawesome-merge mochawesome-report-generator mochawesome-report-generator mochawesome mocha

  #     - name: Publish Merged HTML Report
  #       if: always()
  #       run: |
  #         mkdir -p cypress/reports/mochareports
  #         npx mochawesome-merge cypress/reports/1/mocha/*.json cypress/reports/3/mocha/*.json cypress/reports/4/mocha/*.json cypress/reports/5/mocha/*.json cypress/reports/6/mocha/*.json cypress/reports/7/mocha/*.json  > cypress/reports/mochareports/report.json
  #         npx marge cypress/reports/mochareports/report.json -f report -o cypress/reports/mochareports
  #         mv -fu cypress/reports/1/mochareports/assets/* cypress/reports/mochareports/assets/
  #         mv -fu cypress/reports/3/mochareports/assets/* cypress/reports/mochareports/assets/
  #         mv -fu cypress/reports/4/mochareports/assets/* cypress/reports/mochareports/assets/
  #         mv -fu cypress/reports/5/mochareports/assets/* cypress/reports/mochareports/assets/
  #         mv -fu cypress/reports/6/mochareports/assets/* cypress/reports/mochareports/assets/
  #         mv -fu cypress/reports/7/mochareports/assets/* cypress/reports/mochareports/assets/
      
  #     - name: Change report name
  #       run: mv cypress/reports/mochareports/report.html cypress/reports/mochareports/index.html
  #       if: always()

  #     - name: Upload report
  #       if: always()
  #       uses: actions/upload-artifact@master
  #       with:
  #         name: E2E Test Reports
  #         path: cypress/reports/mochareports

  #     - name: Deploy report to Github Pages
  #       uses: peaceiris/actions-gh-pages@v3
  #       if: always()
  #       with:
  #         github_token: ${{ secrets.GITHUB_TOKEN }}
  #         publish_branch: gh-pages
  #         publish_dir: cypress/reports/mochareports